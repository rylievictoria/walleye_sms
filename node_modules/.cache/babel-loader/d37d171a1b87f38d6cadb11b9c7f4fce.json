{"ast":null,"code":"import _regeneratorRuntime from\"/Users/rhendren/walleye_sms/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/rhendren/walleye_sms/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/rhendren/walleye_sms/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useMemo,useContext,createContext}from\"react\";import queryString from\"query-string\";import firebase from\"./firebase\";import{useUser,createUser,updateUser}from\"./db\";import{history}from\"./router\";import PageLoader from\"./../components/PageLoader\";import{getFriendlyPlanId}from\"./prices\";import analytics from\"./analytics\";// Whether to merge extra user data from database into auth.user\nvar MERGE_DB_USER=true;// Whether to send email verification on signup\nvar EMAIL_VERIFICATION=true;// Whether to connect analytics session to user.uid\nvar ANALYTICS_IDENTIFY=true;var authContext=createContext();// Context Provider component that wraps your app and makes auth object\n// available to any child component that calls the useAuth() hook.\nexport function ProvideAuth(_ref){var children=_ref.children;var auth=useProvideAuth();return/*#__PURE__*/React.createElement(authContext.Provider,{value:auth},children);}// Hook that enables any component to subscribe to auth state\nexport var useAuth=function useAuth(){return useContext(authContext);};// Provider hook that creates auth object and handles state\nfunction useProvideAuth(){// Store auth user object\nvar _useState=useState(null),_useState2=_slicedToArray(_useState,2),user=_useState2[0],setUser=_useState2[1];// Format final user object and merge extra data from database\nvar finalUser=usePrepareUser(user);// Connect analytics session to user\nuseIdentifyUser(finalUser);// Handle response from authentication functions\nvar handleAuth=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(response){var user,additionalUserInfo;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:user=response.user,additionalUserInfo=response.additionalUserInfo;// Ensure Firebase is actually ready before we continue\n_context.next=3;return waitForFirebase();case 3:if(!additionalUserInfo.isNewUser){_context.next=7;break;}_context.next=6;return createUser(user.uid,{email:user.email});case 6:// Send email verification if enabled\nif(EMAIL_VERIFICATION){firebase.auth().currentUser.sendEmailVerification();}case 7:// Update user in state\nsetUser(user);return _context.abrupt(\"return\",user);case 9:case\"end\":return _context.stop();}}},_callee);}));return function handleAuth(_x){return _ref2.apply(this,arguments);};}();var signup=function signup(email,password){return firebase.auth().createUserWithEmailAndPassword(email,password).then(handleAuth);};var signin=function signin(email,password){return firebase.auth().signInWithEmailAndPassword(email,password).then(handleAuth);};var signinWithProvider=function signinWithProvider(name){// Get provider data by name (\"password\", \"google\", etc)\nvar providerData=allProviders.find(function(p){return p.name===name;});var provider=new providerData.providerMethod();if(providerData.parameters){provider.setCustomParameters(providerData.parameters);}return firebase.auth().signInWithPopup(provider).then(handleAuth);};var signout=function signout(){return firebase.auth().signOut();};var sendPasswordResetEmail=function sendPasswordResetEmail(email){return firebase.auth().sendPasswordResetEmail(email);};var confirmPasswordReset=function confirmPasswordReset(password,code){// Get code from query string object\nvar resetCode=code||getFromQueryString(\"oobCode\");return firebase.auth().confirmPasswordReset(resetCode,password);};var updateEmail=function updateEmail(email){return firebase.auth().currentUser.updateEmail(email).then(function(){// Update user in state (since onAuthStateChanged doesn't get called)\nsetUser(firebase.auth().currentUser);});};var updatePassword=function updatePassword(password){return firebase.auth().currentUser.updatePassword(password);};// Update auth user and persist to database (including any custom values in data)\n// Forms can call this function instead of multiple auth/db update functions\nvar updateProfile=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(data){var email,name,picture,sheetLink,phoneCol,deliveries,fields;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:email=data.email,name=data.name,picture=data.picture,sheetLink=data.sheetLink,phoneCol=data.phoneCol,deliveries=data.deliveries;// Update auth email\nif(!email){_context2.next=4;break;}_context2.next=4;return firebase.auth().currentUser.updateEmail(email);case 4:if(!(name||picture)){_context2.next=13;break;}fields={};if(deliveries)fields.deliveries=deliveries;if(name)fields.displayName=name;if(picture)fields.photoURL=picture;if(sheetLink)fields.sheetURL=sheetLink;if(phoneCol)fields.phoneColumn=phoneCol;_context2.next=13;return firebase.auth().currentUser.updateProfile(fields);case 13:_context2.next=15;return updateUser(user.uid,data);case 15:// Update user in state\nsetUser(firebase.auth().currentUser);case 16:case\"end\":return _context2.stop();}}},_callee2);}));return function updateProfile(_x2){return _ref3.apply(this,arguments);};}();useEffect(function(){// Subscribe to user on mount\nvar unsubscribe=firebase.auth().onAuthStateChanged(function(user){if(user){setUser(user);}else{setUser(false);}});// Unsubscribe on cleanup\nreturn function(){return unsubscribe();};},[]);return{user:finalUser,signup:signup,signin:signin,signinWithProvider:signinWithProvider,signout:signout,sendPasswordResetEmail:sendPasswordResetEmail,confirmPasswordReset:confirmPasswordReset,updateEmail:updateEmail,updatePassword:updatePassword,updateProfile:updateProfile};}// Format final user object and merge extra data from database\nfunction usePrepareUser(user){// Fetch extra data from database (if enabled and auth user has been fetched)\nvar userDbQuery=useUser(MERGE_DB_USER&&user&&user.uid);// Memoize so we only create a new object if user or userDbQuery changes\nreturn useMemo(function(){// Return if auth user is null (loading) or false (not authenticated)\nif(!user)return user;// Data we want to include from auth user object\nvar finalUser={uid:user.uid,email:user.email,emailVerified:user.emailVerified,name:user.displayName,picture:user.photoURL};// Include an array of user's auth providers, such as [\"password\", \"google\", etc]\n// Components can read this to prompt user to re-auth with the correct provider\nfinalUser.providers=user.providerData.map(function(_ref4){var providerId=_ref4.providerId;return allProviders.find(function(p){return p.id===providerId;}).name;});// If merging user data from database is enabled ...\nif(MERGE_DB_USER){switch(userDbQuery.status){case\"idle\":// Return null user until we have db data to merge\nreturn null;case\"loading\":return null;case\"error\":// Log query error to console\nconsole.error(userDbQuery.error);return null;case\"success\":// If user data doesn't exist we assume this means user just signed up and the createUser\n// function just hasn't completed. We return null to indicate a loading state.\nif(userDbQuery.data===null)return null;// Merge user data from database into finalUser object\nObject.assign(finalUser,userDbQuery.data);// Get values we need for setting up some custom fields below\nvar _userDbQuery$data=userDbQuery.data,stripePriceId=_userDbQuery$data.stripePriceId,stripeSubscriptionStatus=_userDbQuery$data.stripeSubscriptionStatus;// Add planId field (such as \"basic\", \"premium\", etc) based on stripePriceId\nif(stripePriceId){finalUser.planId=getFriendlyPlanId(stripePriceId);}// Add planIsActive field and set to true if subscription status is \"active\" or \"trialing\"\nfinalUser.planIsActive=[\"active\",\"trialing\"].includes(stripeSubscriptionStatus);// no default\n}}return finalUser;},[user,userDbQuery]);}// A Higher Order Component for requiring authentication\nexport var requireAuth=function requireAuth(Component){return function(props){// Get authenticated user\nvar auth=useAuth();useEffect(function(){// Redirect if not signed in\nif(auth.user===false){history.replace(\"/auth/signin\");}},[auth]);// Show loading indicator\n// We're either loading (user is null) or we're about to redirect (user is false)\nif(!auth.user){return/*#__PURE__*/React.createElement(PageLoader,null);}// Render component now that we have user\nreturn/*#__PURE__*/React.createElement(Component,props);};};// Handle Firebase email link for reverting to original email\nexport var handleRecoverEmail=function handleRecoverEmail(code){var originalEmail;return firebase.auth().checkActionCode(code).then(function(info){originalEmail=info.data.email;// Revert to original email by applying action code\nreturn firebase.auth().applyActionCode(code);}).then(function(){// Send password reset email so user can change their pass if they\n// think someone else has access to their account.\nreturn firebase.auth().sendPasswordResetEmail(originalEmail);}).then(function(){// Return original email so it can be displayed by calling component\nreturn originalEmail;});};// Handle Firebase email link for verifying email\nexport var handleVerifyEmail=function handleVerifyEmail(code){return firebase.auth().applyActionCode(code);};var allProviders=[{id:\"password\",name:\"password\"},{id:\"google.com\",name:\"google\",providerMethod:firebase.auth.GoogleAuthProvider},{id:\"facebook.com\",name:\"facebook\",providerMethod:firebase.auth.FacebookAuthProvider,parameters:{// Tell fb to show popup size UI instead of full website\ndisplay:\"popup\"}},{id:\"twitter.com\",name:\"twitter\",providerMethod:firebase.auth.TwitterAuthProvider},{id:\"github.com\",name:\"github\",providerMethod:firebase.auth.GithubAuthProvider}];// Connect analytics session to current user.uid\nfunction useIdentifyUser(user){useEffect(function(){if(ANALYTICS_IDENTIFY&&user){analytics.identify(user.uid);}},[user]);}// Waits on Firebase user to be initialized before resolving promise\n// This is used to ensure auth is ready before any writing to the db can happen\nvar waitForFirebase=function waitForFirebase(){return new Promise(function(resolve){var unsubscribe=firebase.auth().onAuthStateChanged(function(user){if(user){resolve(user);// Resolve promise when we have a user\nunsubscribe();// Prevent from firing again\n}});});};var getFromQueryString=function getFromQueryString(key){return queryString.parse(window.location.search)[key];};","map":{"version":3,"sources":["/Users/rhendren/walleye_sms/src/util/auth.js"],"names":["React","useState","useEffect","useMemo","useContext","createContext","queryString","firebase","useUser","createUser","updateUser","history","PageLoader","getFriendlyPlanId","analytics","MERGE_DB_USER","EMAIL_VERIFICATION","ANALYTICS_IDENTIFY","authContext","ProvideAuth","children","auth","useProvideAuth","useAuth","user","setUser","finalUser","usePrepareUser","useIdentifyUser","handleAuth","response","additionalUserInfo","waitForFirebase","isNewUser","uid","email","currentUser","sendEmailVerification","signup","password","createUserWithEmailAndPassword","then","signin","signInWithEmailAndPassword","signinWithProvider","name","providerData","allProviders","find","p","provider","providerMethod","parameters","setCustomParameters","signInWithPopup","signout","signOut","sendPasswordResetEmail","confirmPasswordReset","code","resetCode","getFromQueryString","updateEmail","updatePassword","updateProfile","data","picture","sheetLink","phoneCol","deliveries","fields","displayName","photoURL","sheetURL","phoneColumn","unsubscribe","onAuthStateChanged","userDbQuery","emailVerified","providers","map","providerId","id","status","console","error","Object","assign","stripePriceId","stripeSubscriptionStatus","planId","planIsActive","includes","requireAuth","Component","props","replace","handleRecoverEmail","originalEmail","checkActionCode","info","applyActionCode","handleVerifyEmail","GoogleAuthProvider","FacebookAuthProvider","display","TwitterAuthProvider","GithubAuthProvider","identify","Promise","resolve","key","parse","window","location","search"],"mappings":"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","sourcesContent":["import React, {\n  useState,\n  useEffect,\n  useMemo,\n  useContext,\n  createContext,\n} from \"react\";\nimport queryString from \"query-string\";\nimport firebase from \"./firebase\";\nimport { useUser, createUser, updateUser } from \"./db\";\nimport { history } from \"./router\";\nimport PageLoader from \"./../components/PageLoader\";\nimport { getFriendlyPlanId } from \"./prices\";\nimport analytics from \"./analytics\";\n\n// Whether to merge extra user data from database into auth.user\nconst MERGE_DB_USER = true;\n// Whether to send email verification on signup\nconst EMAIL_VERIFICATION = true;\n// Whether to connect analytics session to user.uid\nconst ANALYTICS_IDENTIFY = true;\n\nconst authContext = createContext();\n\n// Context Provider component that wraps your app and makes auth object\n// available to any child component that calls the useAuth() hook.\nexport function ProvideAuth({ children }) {\n  const auth = useProvideAuth();\n  return <authContext.Provider value={auth}>{children}</authContext.Provider>;\n}\n\n// Hook that enables any component to subscribe to auth state\nexport const useAuth = () => {\n  return useContext(authContext);\n};\n\n// Provider hook that creates auth object and handles state\nfunction useProvideAuth() {\n  // Store auth user object\n  const [user, setUser] = useState(null);\n\n  // Format final user object and merge extra data from database\n  const finalUser = usePrepareUser(user);\n\n  // Connect analytics session to user\n  useIdentifyUser(finalUser);\n\n  // Handle response from authentication functions\n  const handleAuth = async (response) => {\n    const { user, additionalUserInfo } = response;\n\n    // Ensure Firebase is actually ready before we continue\n    await waitForFirebase();\n\n    // Create the user in the database if they are new\n    if (additionalUserInfo.isNewUser) {\n      await createUser(user.uid, { email: user.email });\n\n      // Send email verification if enabled\n      if (EMAIL_VERIFICATION) {\n        firebase.auth().currentUser.sendEmailVerification();\n      }\n    }\n\n    // Update user in state\n    setUser(user);\n    return user;\n  };\n\n  const signup = (email, password) => {\n    return firebase\n      .auth()\n      .createUserWithEmailAndPassword(email, password)\n      .then(handleAuth);\n  };\n\n  const signin = (email, password) => {\n    return firebase\n      .auth()\n      .signInWithEmailAndPassword(email, password)\n      .then(handleAuth);\n  };\n\n  const signinWithProvider = (name) => {\n    // Get provider data by name (\"password\", \"google\", etc)\n    const providerData = allProviders.find((p) => p.name === name);\n\n    const provider = new providerData.providerMethod();\n\n    if (providerData.parameters) {\n      provider.setCustomParameters(providerData.parameters);\n    }\n\n    return firebase.auth().signInWithPopup(provider).then(handleAuth);\n  };\n\n  const signout = () => {\n    return firebase.auth().signOut();\n  };\n\n  const sendPasswordResetEmail = (email) => {\n    return firebase.auth().sendPasswordResetEmail(email);\n  };\n\n  const confirmPasswordReset = (password, code) => {\n    // Get code from query string object\n    const resetCode = code || getFromQueryString(\"oobCode\");\n\n    return firebase.auth().confirmPasswordReset(resetCode, password);\n  };\n\n  const updateEmail = (email) => {\n    return firebase\n      .auth()\n      .currentUser.updateEmail(email)\n      .then(() => {\n        // Update user in state (since onAuthStateChanged doesn't get called)\n        setUser(firebase.auth().currentUser);\n      });\n  };\n\n  const updatePassword = (password) => {\n    return firebase.auth().currentUser.updatePassword(password);\n  };\n\n  // Update auth user and persist to database (including any custom values in data)\n  // Forms can call this function instead of multiple auth/db update functions\n  const updateProfile = async (data) => {\n    const { email, name, picture, sheetLink, phoneCol, deliveries } = data;\n\n    // Update auth email\n    if (email) {\n      await firebase.auth().currentUser.updateEmail(email);\n    }\n\n    // Update auth profile fields\n    if (name || picture) {\n      let fields = {};\n      if (deliveries) fields.deliveries = deliveries;\n      if (name) fields.displayName = name;\n      if (picture) fields.photoURL = picture;\n      if (sheetLink) fields.sheetURL = sheetLink;\n      if (phoneCol) fields.phoneColumn = phoneCol;\n      await firebase.auth().currentUser.updateProfile(fields);\n    }\n\n    // Persist all data to the database\n    await updateUser(user.uid, data);\n\n    // Update user in state\n    setUser(firebase.auth().currentUser);\n  };\n\n  useEffect(() => {\n    // Subscribe to user on mount\n    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {\n      if (user) {\n        setUser(user);\n      } else {\n        setUser(false);\n      }\n    });\n\n    // Unsubscribe on cleanup\n    return () => unsubscribe();\n  }, []);\n\n  return {\n    user: finalUser,\n    signup,\n    signin,\n    signinWithProvider,\n    signout,\n    sendPasswordResetEmail,\n    confirmPasswordReset,\n    updateEmail,\n    updatePassword,\n    updateProfile,\n  };\n}\n\n// Format final user object and merge extra data from database\nfunction usePrepareUser(user) {\n  // Fetch extra data from database (if enabled and auth user has been fetched)\n  const userDbQuery = useUser(MERGE_DB_USER && user && user.uid);\n\n  // Memoize so we only create a new object if user or userDbQuery changes\n  return useMemo(() => {\n    // Return if auth user is null (loading) or false (not authenticated)\n    if (!user) return user;\n\n    // Data we want to include from auth user object\n    let finalUser = {\n      uid: user.uid,\n      email: user.email,\n      emailVerified: user.emailVerified,\n      name: user.displayName,\n      picture: user.photoURL,\n    };\n\n    // Include an array of user's auth providers, such as [\"password\", \"google\", etc]\n    // Components can read this to prompt user to re-auth with the correct provider\n    finalUser.providers = user.providerData.map(({ providerId }) => {\n      return allProviders.find((p) => p.id === providerId).name;\n    });\n\n    // If merging user data from database is enabled ...\n    if (MERGE_DB_USER) {\n      switch (userDbQuery.status) {\n        case \"idle\":\n          // Return null user until we have db data to merge\n          return null;\n        case \"loading\":\n          return null;\n        case \"error\":\n          // Log query error to console\n          console.error(userDbQuery.error);\n          return null;\n        case \"success\":\n          // If user data doesn't exist we assume this means user just signed up and the createUser\n          // function just hasn't completed. We return null to indicate a loading state.\n          if (userDbQuery.data === null) return null;\n\n          // Merge user data from database into finalUser object\n          Object.assign(finalUser, userDbQuery.data);\n\n          // Get values we need for setting up some custom fields below\n          const { stripePriceId, stripeSubscriptionStatus } = userDbQuery.data;\n\n          // Add planId field (such as \"basic\", \"premium\", etc) based on stripePriceId\n          if (stripePriceId) {\n            finalUser.planId = getFriendlyPlanId(stripePriceId);\n          }\n\n          // Add planIsActive field and set to true if subscription status is \"active\" or \"trialing\"\n          finalUser.planIsActive = [\"active\", \"trialing\"].includes(\n            stripeSubscriptionStatus\n          );\n\n        // no default\n      }\n    }\n\n    return finalUser;\n  }, [user, userDbQuery]);\n}\n\n// A Higher Order Component for requiring authentication\nexport const requireAuth = (Component) => {\n  return (props) => {\n    // Get authenticated user\n    const auth = useAuth();\n\n    useEffect(() => {\n      // Redirect if not signed in\n      if (auth.user === false) {\n        history.replace(\"/auth/signin\");\n      }\n    }, [auth]);\n\n    // Show loading indicator\n    // We're either loading (user is null) or we're about to redirect (user is false)\n    if (!auth.user) {\n      return <PageLoader />;\n    }\n\n    // Render component now that we have user\n    return <Component {...props} />;\n  };\n};\n\n// Handle Firebase email link for reverting to original email\nexport const handleRecoverEmail = (code) => {\n  let originalEmail;\n  return firebase\n    .auth()\n    .checkActionCode(code)\n    .then((info) => {\n      originalEmail = info.data.email;\n      // Revert to original email by applying action code\n      return firebase.auth().applyActionCode(code);\n    })\n    .then(() => {\n      // Send password reset email so user can change their pass if they\n      // think someone else has access to their account.\n      return firebase.auth().sendPasswordResetEmail(originalEmail);\n    })\n    .then(() => {\n      // Return original email so it can be displayed by calling component\n      return originalEmail;\n    });\n};\n\n// Handle Firebase email link for verifying email\nexport const handleVerifyEmail = (code) => {\n  return firebase.auth().applyActionCode(code);\n};\n\nconst allProviders = [\n  {\n    id: \"password\",\n    name: \"password\",\n  },\n  {\n    id: \"google.com\",\n    name: \"google\",\n    providerMethod: firebase.auth.GoogleAuthProvider,\n  },\n  {\n    id: \"facebook.com\",\n    name: \"facebook\",\n    providerMethod: firebase.auth.FacebookAuthProvider,\n    parameters: {\n      // Tell fb to show popup size UI instead of full website\n      display: \"popup\",\n    },\n  },\n  {\n    id: \"twitter.com\",\n    name: \"twitter\",\n    providerMethod: firebase.auth.TwitterAuthProvider,\n  },\n  {\n    id: \"github.com\",\n    name: \"github\",\n    providerMethod: firebase.auth.GithubAuthProvider,\n  },\n];\n\n// Connect analytics session to current user.uid\nfunction useIdentifyUser(user) {\n  useEffect(() => {\n    if (ANALYTICS_IDENTIFY && user) {\n      analytics.identify(user.uid);\n    }\n  }, [user]);\n}\n\n// Waits on Firebase user to be initialized before resolving promise\n// This is used to ensure auth is ready before any writing to the db can happen\nconst waitForFirebase = () => {\n  return new Promise((resolve) => {\n    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {\n      if (user) {\n        resolve(user); // Resolve promise when we have a user\n        unsubscribe(); // Prevent from firing again\n      }\n    });\n  });\n};\n\nconst getFromQueryString = (key) => {\n  return queryString.parse(window.location.search)[key];\n};\n"]},"metadata":{},"sourceType":"module"}